apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: app-postgres
  namespace: app-namespace
spec:
  instances: 3

  # Storage configuration
  storage:
    size: 1Gi
    storageClass: standard

  # Bootstrap configuration
  bootstrap:
    initdb:
      database: app
      owner: app
      secret:
        name: database-credentials
      postInitApplicationSQL:
        # Create migrate-runner user for running database migrations
        - CREATE USER "migrate-runner";
        - GRANT ALL PRIVILEGES ON DATABASE app TO "migrate-runner";
        - GRANT ALL PRIVILEGES ON SCHEMA public TO "migrate-runner";
        - GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO "migrate-runner";
        - GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO "migrate-runner";
        - ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO "migrate-runner";
        - ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO "migrate-runner";

  # PostgreSQL configuration
  postgresql:
    parameters:
      max_connections: "100"
      shared_buffers: "256MB"
      ssl: "on"
      ssl_cert_file: "/run/secrets/postgres-server-tls/tls.crt"
      ssl_key_file: "/run/secrets/postgres-server-tls/tls.key"
      ssl_ca_file: "/run/secrets/postgres-ca/ca-bundle.crt"
    pg_hba:
      # Certificate authentication for migrate-runner
      - hostssl app migrate-runner 0.0.0.0/0 cert clientcert=verify-full
      # Certificate authentication for grpcserver
      - hostssl app grpcserver 0.0.0.0/0 cert clientcert=verify-full

  # SSL/TLS Configuration
  certificates:
    serverTLSSecret: postgres-server-tls
    serverCASecret: postgres-ca-bundle
    clientCASecret: postgres-ca-bundle
    replicationTLSSecret: postgres-server-tls

  # Monitoring
  monitoring:
    enablePodMonitor: false

  # Resource limits
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "1Gi"
      cpu: "1000m"
