apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: app-postgres
  namespace: app-namespace
spec:
  instances: 3

  # Storage configuration
  storage:
    size: 1Gi
    storageClass: standard

  # Bootstrap configuration
  bootstrap:
    initdb:
      database: config
      postInitApplicationSQL:
        # Create dbmate role with CREATEROLE privilege
        - CREATE ROLE  "dbmate" WITH LOGIN CREATEROLE;
        # Grant privileges to dbmate
        - GRANT ALL PRIVILEGES ON DATABASE config TO "dbmate";
        - GRANT ALL PRIVILEGES ON SCHEMA public TO "dbmate";
        - GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO "dbmate";
        - GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO "dbmate";
        - ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO "dbmate";
        - ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO "dbmate";

  # PostgreSQL configuration
  postgresql:
    parameters:
      max_connections: "100"
      shared_buffers: "256MB"
    pg_hba:
      # Certificate-only authentication for application users
      - hostssl   config        dbmate          0.0.0.0/0 cert clientcert=verify-full
      - hostssl   config        grpcserver      0.0.0.0/0 cert clientcert=verify-full
      # reject the rest
      - host      all           all             all            reject

  # SSL/TLS Configuration
  certificates:
    serverTLSSecret: postgres-server-tls
    serverCASecret: postgres-ca-bundle
    clientCASecret: postgres-ca-bundle
    replicationTLSSecret: postgres-replication-tls

  # Monitoring
  monitoring:
    enablePodMonitor: false

  # Resource limits
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "1Gi"
      cpu: "1000m"
